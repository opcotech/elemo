# Logging

| author       | created at | updated at | status   |
| :----------- | :--------- | ---------- | :------- |
| @gabor-boros | 2025-10-31 | -        | accepted |

## Abstract

This ADR documents the decision to adopt structured logging using Go's standard library `log/slog` package. Structured logging enables better observability, log aggregation, and analysis in production environments. The decision establishes best practices for log field naming, PII handling, event type conventions, and context object patterns to ensure consistency, security, and compliance across the application.

## Decision

### Structured Logging

We will use structured logging throughout the application instead of plain text logging. Structured logs are machine-readable and enable better querying, filtering, and analysis in log aggregation systems.

### Standard Library Over External Packages

We will use Go's standard library `log/slog` package (introduced in Go 1.21) over external logging packages such as `zap`, `logrus`, or `zerolog`. This decision is based on:

- **Standardization**: Being part of the standard library ensures long-term stability and wide adoption
- **Minimal Dependencies**: Reduces external dependencies and version management overhead
- **Adequate Functionality**: `slog` provides sufficient features for structured logging needs
- **Performance**: Standard library implementations are typically well-optimized
- **Consistency**: Ensures all Go code in the ecosystem uses the same logging interface

The implementation wraps `slog.Logger` to provide a consistent interface (`internal/pkg/log.Logger`) that supports context-aware logging and maintains compatibility with existing code patterns.

### Log Format

All logs are output in JSON format using `slog.NewJSONHandler` to ensure compatibility with log aggregation systems (e.g., Elasticsearch, Loki, CloudWatch).

### Standard Log Fields

All log entries should include the following standard fields when applicable:

| Field         | Description                                  |
| ------------- | -------------------------------------------- |
| `event_id`    | XID or UUID for deduplication                |
| `event_type`  | e.g. `user.signup`, `organization.created`   |
| `user_id`     | Resource ID of the user                      |
| `session_id`  | To group related actions                     |
| `request_id`  | For distributed tracing                      |
| `metadata`    | Structured key-value pairs for extra context |
| `level`       | e.g. `info`, `error`, `fatal`                |
| `error_code`  | Standardized code for errors                 |
| `timestamp`   | ISO-8601 timestamp when the event occurred   |

These fields are implemented as helper functions in `internal/pkg/log/field.go` (e.g., `WithRequestID`, `WithUserID`, `WithStatus`).

### Event Type Naming Convention

Event types follow the `noun.verb` naming convention:

- **Format**: `{entity}.{action}`
- **Examples**:
    - `user.created`
    - `user.updated`
    - `user.deleted`
    - `invoice.paid`
    - `payment.failed`
    - `session.created`

This convention provides clear, hierarchical categorization of events and enables easy filtering and aggregation by entity type or action.

### Context Objects

For complex events, use a structured `context` object to group related fields:

```json
{
    "event_type": "payment.failed",
    "context": {
        "user_id": "u123",
        "payment_id": "p456",
        "reason": "card_declined"
    }
}
```

The context object should be used when:

- Multiple related fields need to be grouped together
- The event has nested or complex structure
- Related fields should be queried together

### PII and Security Guidelines

**Never log PII unless essential**:

- Avoid logging passwords, credit card numbers, API keys, tokens, or other sensitive credentials
- Use pseudonymization or hashing for user identifiers when possible
- Implement field-level data classification to identify sensitive fields

**Field Classification**:

- Mark fields as sensitive in code/documentation
- Use helper functions that automatically apply pseudonymization
- Document which fields require special handling

### Implementation Example

```go
import (
    "github.com/opcotech/elemo/internal/pkg/log"
)

// Example: Logging a user creation event
log.Info(
    ctx,
    "User account created",
    log.WithAction(log.ActionAuthUserAuthenticate),
    log.WithUserID(userID),
    log.WithRequestID(requestID),
    log.WithStatus(log.StatusSuccess),
)
```

## Consequences

### Positive

- **Observability**: Structured logs enable better monitoring, alerting, and debugging
- **Log Aggregation**: JSON format is compatible with all major log aggregation systems
- **Query Performance**: Structured fields enable fast filtering and searching
- **Standardization**: Using stdlib reduces maintenance burden and ensures compatibility
- **Security**: PII guidelines reduce risk of data exposure
- **Consistency**: Naming conventions make logs predictable and easier to analyze

### Negative

- **Performance Overhead**: JSON encoding may have slight performance overhead compared to plain text
- **Field Management**: Need to maintain consistency in field naming and ensure all relevant fields are included

### Risks and Mitigations

1. **Risk**: Inconsistent field usage across codebase
    - **Mitigation**: Use helper functions from `internal/pkg/log/field.go` and code review

2. **Risk**: Accidental PII logging
    - **Mitigation**: Implement log filtering middleware (see TODO in code), code review, and automated scanning

3. **Risk**: Missing required fields in logs
    - **Mitigation**: Use context-aware logging that automatically includes request_id, user_id, etc. from context

4. **Risk**: Performance impact from excessive logging
    - **Mitigation**: Use appropriate log levels, configure log levels per environment, and monitor log volume

## References

- [Go log/slog package documentation](https://pkg.go.dev/log/slog)
- [Structured Logging Best Practices](https://www.structlog.org/en/stable/)
- [OWASP Logging Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html)
- Internal implementation: `internal/pkg/log/log.go`
- Field helpers: `internal/pkg/log/field.go`
- Action types: `internal/pkg/log/action.go`
