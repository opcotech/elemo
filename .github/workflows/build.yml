name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  backend-lint:
    name: Backend Lint
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "^1.25"
      - name: Go CI Lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: latest
          args: --timeout 5m

  frontend-lint:
    name: Frontend Lint
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20.x"
      - name: Install tooling
        run: npm install -g pnpm
      - name: Lint
        run: make dep.frontend lint.frontend

  backend-unit-test:
    name: Backend Unit Tests
    runs-on: "ubuntu-latest"
    needs:
      - backend-lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "^1.25"
      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest
      - name: Execute unit tests
        run: make test.backend.unit
      - name: Stash test results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: "unit-test-results"
          path: .coverage.unit.out
          include-hidden-files: true
          retention-days: 7

  backend-benchmark-test:
    name: Backend Benchmark Tests
    runs-on: "ubuntu-latest"
    needs:
      - backend-lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "^1.25"
      - name: Execute benchmark tests
        run: make test.backend.bench

  backend-integration-test:
    name: Backend Integration Tests
    runs-on: "ubuntu-latest"
    needs:
      - backend-unit-test
      - backend-benchmark-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "^1.25"
      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest
      - name: Execute integration tests
        run: make test.backend.integration
      - name: Stash test results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: "integration-test-results"
          path: .coverage.integration.out
          include-hidden-files: true
          retention-days: 7

  frontend-e2e-test:
    name: Frontend E2E Tests - ${{ matrix.project }} (shard ${{ matrix.shard }}/${{ matrix.total-shards }})
    runs-on: "ubuntu-latest"
    needs:
      - frontend-lint
      - backend-integration-test
    strategy:
      matrix:
        shard: [1, 2, 3]
        total-shards: [3]
        project:
          - chromium
          - firefox
          - webkit
          # FIXME: enable "Mobile Chrome" once we support mobile viewports
          # FIXME: enable "Mobile Safari" once we support mobile viewports
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20.x"
      - uses: actions/setup-go@v5
        with:
          go-version: "^1.25"
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Install tooling
        run: |
          pip install jq yq
          npm install -g pnpm
      - name: Setup local env
        run: |
          ./scripts/setup.sh
          sed -i s/CI=false/CI=true/g web/.env.test.local

          make start.backend

          # Wait for elemo-server to be ready
          timeout=15
          attempt=0

          while [ $attempt -lt $timeout ]; do
            if curl -sf "http://127.0.0.1:35478/v1/system/heartbeat" > /dev/null 2>&1; then
              echo "elemo-server is ready"
              break
            fi
            echo "Waiting for elemo-server to be ready... (attempt $((attempt + 1))/$timeout)"
            sleep 2
            attempt=$((attempt + 1))
          done

          if [ $attempt -eq $timeout ]; then
            echo "ERROR: elemo-server did not become ready within $((timeout * 2)) seconds"
            docker compose -f deploy/docker/docker-compose.yml ps
            docker compose -f deploy/docker/docker-compose.yml logs elemo-server
            exit 1
          fi

      - name: Execute end-to-end tests
        run: |
          pnpm --prefix web test:e2e --project "${{ matrix.project }}" --shard=${{ matrix.shard }}/${{ matrix.total-shards }}
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "e2e-test-results-${{ matrix.project }}-shard-${{ matrix.shard }}"
          path: web/test-results
          retention-days: 7
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "playwright-report-${{ matrix.project }}-shard-${{ matrix.shard }}"
          path: web/playwright-report
          retention-days: 7
      - name: Stop backend services
        if: always()
        run: |
          make stop.backend

  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs:
      - backend-integration-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "^1.25"
      - name: Unstash unit test results
        uses: actions/download-artifact@v4
        with:
          name: "unit-test-results"
      - name: Unstash integration test results
        uses: actions/download-artifact@v4
        with:
          name: "integration-test-results"
      - name: Combine coverage reports
        run: make test.backend.coverage
      - name: Upload coverage report
        uses: codecov/codecov-action@v5
        with:
          files: .coverage.out
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: opcotech/elemo
          fail_ci_if_error: true
